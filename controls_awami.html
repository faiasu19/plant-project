<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plant Interaction</title>

<!-- Awami Nastaliq font -->
<link href="https://fonts.googleapis.com/css2?family=Awami+Nastaliq&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Awami Nastaliq', serif;
    background: #f0f4f8;
    padding: 20px;
    color: #111;
}
h2 {
    text-align: center;
    color: #0ea5a4;
}
.container {
    max-width: 500px;
    margin: 0 auto;
    background: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}
input, textarea {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
}
textarea { resize: none; }
button {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    font-size: 16px;
    margin-bottom: 10px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}
.btn-primary { background: #0ea5a4; color: #fff; }
.btn-ghost { background: #eef2f7; color: #111; }
.info-box {
    background: #f1f5f9;
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
    font-size: 15px;
}
#qrImg { margin-top: 10px; max-width: 200px; display: block; margin-left: auto; margin-right: auto; }
.row { display:flex; gap:10px; flex-wrap: wrap; margin-bottom: 12px; }
.row input { flex:1; }
</style>
</head>
<body>

<h2>Plant Interaction: Kalanchoe blossfeldiana</h2>

<div class="container">

<input id="plantName" type="text" placeholder="Plant Name" value="Kalanchoe blossfeldiana">
<textarea id="desc" rows="4" placeholder="Description">Succulent plant from the Crassulaceae family, originally from Madagascar. It has thick, smooth leaves that store water and small colorful flowers (red, pink, yellow, orange) appearing in late winter or early spring.</textarea>

<input id="lastWatered" type="date">
<input id="intervalDays" type="number" placeholder="Watering Interval (days)" value="7">

<div class="row">
<input id="tempMin" type="number" placeholder="Min Temperature (°C)" value="18">
<input id="tempMax" type="number" placeholder="Max Temperature (°C)" value="24">
</div>

<button id="calcNext" class="btn-primary">Calculate Next Watering</button>
<button id="markNow" class="btn-ghost">Watered Now</button>

<div class="info-box" id="resultBox" style="display:none;">
  <div id="resPlant" style="font-weight:700; font-size:17px; margin-bottom:6px;"></div>
  <div id="nextDateText"></div>
  <div class="small" id="intervalText"></div>
  <div class="small" id="tempText"></div>
  <img id="qrImg" alt="QR Code">
  <button id="downloadQr" class="btn-primary">Download QR</button>
  <button id="downloadIcs" class="btn-ghost">Download ICS</button>
</div>

</div>

<script>
(function(){
  const plantNameEl = document.getElementById('plantName');
  const descEl = document.getElementById('desc');
  const lastWateredEl = document.getElementById('lastWatered');
  const intervalDaysEl = document.getElementById('intervalDays');
  const tempMinEl = document.getElementById('tempMin');
  const tempMaxEl = document.getElementById('tempMax');
  const calcBtn = document.getElementById('calcNext');
  const markNowBtn = document.getElementById('markNow');
  const resultBox = document.getElementById('resultBox');
  const resPlant = document.getElementById('resPlant');
  const nextDateText = document.getElementById('nextDateText');
  const intervalText = document.getElementById('intervalText');
  const tempText = document.getElementById('tempText');
  const qrImg = document.getElementById('qrImg');
  const downloadQrBtn = document.getElementById('downloadQr');
  const downloadIcsBtn = document.getElementById('downloadIcs');

  // Load saved data
  if(localStorage.getItem('plantName')) plantNameEl.value = localStorage.getItem('plantName');
  if(localStorage.getItem('desc')) descEl.value = localStorage.getItem('desc');
  if(localStorage.getItem('lastWatered')) lastWateredEl.value = localStorage.getItem('lastWatered');
  else lastWateredEl.value = new Date().toISOString().slice(0,10);
  if(localStorage.getItem('intervalDays')) intervalDaysEl.value = localStorage.getItem('intervalDays');
  if(localStorage.getItem('tempMin')) tempMinEl.value = localStorage.getItem('tempMin');
  if(localStorage.getItem('tempMax')) tempMaxEl.value = localStorage.getItem('tempMax');

  function formatDateReadable(d){ return new Date(d).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}
  function calcNextDate(){ const last=new Date(lastWateredEl.value); const days=Number(intervalDaysEl.value)||7; return new Date(last.getTime()+days*24*60*60*1000);}
  function buildShareLink(){ return location.origin+location.pathname+'?plant='+encodeURIComponent(plantNameEl.value);}
  function updateQR(){ qrImg.src='https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl='+encodeURIComponent(buildShareLink());}
  function saveData(){
    localStorage.setItem('plantName', plantNameEl.value);
    localStorage.setItem('desc', descEl.value);
    localStorage.setItem('lastWatered', lastWateredEl.value);
    localStorage.setItem('intervalDays', intervalDaysEl.value);
    localStorage.setItem('tempMin', tempMinEl.value);
    localStorage.setItem('tempMax', tempMaxEl.value);
  }

  [plantNameEl, descEl, intervalDaysEl, tempMinEl, tempMaxEl, lastWateredEl].forEach(el=>el.addEventListener('input',()=>{updateQR(); saveData();}));
  updateQR();

  calcBtn.addEventListener('click',function(){
    const next=calcNextDate();
    resPlant.textContent = plantNameEl.value;
    nextDateText.textContent = 'Next watering date: '+formatDateReadable(next);
    intervalText.textContent = `Water every ${intervalDaysEl.value} days (Last watered: ${formatDateReadable(lastWateredEl.value)})`;
    tempText.textContent = `Optimal temperature: ${tempMinEl.value}°C — ${tempMaxEl.value}°C`;
    resultBox.style.display='block';
  });

  markNowBtn.addEventListener('click',function(){
    const nowISO=new Date().toISOString().slice(0,10);
    lastWateredEl.value=nowISO; updateQR(); saveData(); alert('Watering recorded: '+formatDateReadable(nowISO));
  });

  downloadQrBtn.addEventListener('click',function(){ const a=document.createElement('a'); a.href=qrImg.src; a.download=(plantNameEl.value||'plant')+'-qr.png'; document.body.appendChild(a); a.click(); a.remove();});
  downloadIcsBtn.addEventListener('click',function(){
    const occurrences=12; const last=new Date(lastWateredEl.value); const intervalDays=Number(intervalDaysEl.value)||7;
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//PlantCareLocal//EN'];
    for(let i=1;i<=occurrences;i++){
      const ev=new Date(last.getTime()+i*intervalDays*24*60*60*1000);
      const dt=ev.toISOString().slice(0,10).replace(/-/g,'');
      const uid=`${plantNameEl.value.replace(/\s+/g,'')||'plant'}-${i}@local`;
      const dtstamp=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+dtstamp,'DTSTART;VALUE=DATE:'+dt,
                 'SUMMARY:Watering Reminder - '+plantNameEl.value,
                 'DESCRIPTION:'+descEl.value,'END:VEVENT');
    }
    lines.push('END:VCALENDAR');
    const blob=new Blob([lines.join('\r\n')],{type:'text/calendar;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=(plantNameEl.value||'plant')+'-watering.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

})();
</script>
<script src="plant_core.js"></script>
</body>
</html>
